The python code (with some additional c++)